<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.txp.app.system.repository.ManageMapper" >

  <insert id="insertSysLog" parameterType="com.txp.app.system.dto.SysLog" useGeneratedKeys="true" keyProperty="id">
    insert into sys_log (operator,operate_time,description,operate_result,ip) values
    (#{operator},now(),#{description},#{operateResult},#{ip})
  </insert>

  <select id="selectSysOrganization" parameterType="java.lang.Long" resultType="com.txp.app.system.dto.SysOrganization">
    SELECT
        o.id,
        o.org_name AS orgName,
        o.org_code AS orgCode,
        o.org_desc AS orgDesc,
        o.father_id AS fatherId,
        o.lft,
        o.rgt
    FROM
        sys_organization o
    WHERE
        o.id IN(
            SELECT
                org_id
            FROM
                sys_org_dept
            WHERE
                dept_id = #{dId}
        )
    LIMIT 1
  </select>

    <select id="findSysOrganizationList1" parameterType="map" resultType="com.txp.app.system.dto.SysOrganization">
        select o.id,
        o.org_name AS orgName,
        o.org_code AS orgCode,
        o.org_desc AS orgDesc,
        o.father_id AS fatherId,
        o.lft,
        o.rgt from sys_organization o where father_id=(select id from sys_organization where father_id='0')
        <if test="orgId != null" >
            <![CDATA[
           and lft>(select lft from sys_organization where id=#{orgId}
            ) and rgt < (select rgt from sys_organization where id= #{orgId})
            ]]>
        </if>
        <if test="orgName != null" >
            and org_name=#{orgName}
        </if>
        limit #{startIndex},#{endIndex}
    </select>

    <select id="findSysOrganizationList1Count" parameterType="map" resultType="java.lang.Long">
        select count(1) from sys_organization where father_id=(select id from sys_organization where father_id='0')
        <if test="orgId != null" >
            <![CDATA[
           and lft>(select lft from sys_organization where id=#{orgId}
            ) and rgt < (select rgt from sys_organization where id= #{orgId})
            ]]>
        </if>
        <if test="orgName != null" >
            and org_name=#{orgName}
        </if>
    </select>

    <select id="findSysOrganizationList2" parameterType="map" resultType="com.txp.app.system.dto.SysOrganization">
        select o.id,
        o.org_name AS orgName,
        o.org_code AS orgCode,
        o.org_desc AS orgDesc,
        o.father_id AS fatherId,
        o.lft,
        o.rgt from sys_organization o where 1=1
        <if test="orgId != null" >
            <![CDATA[
           and lft>(select lft from sys_organization where id=#{orgId}
            ) and rgt < (select rgt from sys_organization where id= #{orgId})
            ]]>
        </if>
        <if test="orgName != null" >
            and org_name=#{orgName}
        </if>
        limit #{startIndex},#{endIndex}
    </select>

    <select id="findSysOrganizationList2Count" parameterType="map" resultType="java.lang.Long">
        select count(1) from sys_organization where 1=1
        <if test="orgId != null" >
            <![CDATA[
           and lft>(select lft from sys_organization where id=#{orgId}
            ) and rgt < (select rgt from sys_organization where id= #{orgId})
            ]]>
        </if>
        <if test="orgName != null" >
            and org_name=#{orgName}
        </if>
    </select>

    <select id="selectOrgName" parameterType="java.lang.String" resultType="map">
        select org_name from sys_organization where org_name=#{orgName}
    </select>

    <select id="selectOrgIdByOrgName" parameterType="java.lang.String" resultType="java.lang.Long">
        select id from sys_organization where father_id='1' and org_name=#{orgName}
    </select>

    <select id="selectLft" parameterType="map" resultType="java.lang.Integer">
        select tree_org(#{pid},#{orgName},#{orgDesc})
    </select>

    <insert id="insertSysOrganization" parameterType="com.txp.app.system.dto.SysOrganization" useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Jan 03 14:37:06 CST 2018.
        -->
        insert into sys_organization
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="orgName != null" >
                org_name,
            </if>
            <if test="orgCode != null" >
                org_code,
            </if>
            <if test="orgDesc != null" >
                org_desc,
            </if>
            <if test="fatherId != null" >
                father_id,
            </if>
            <if test="lft != null" >
                lft,
            </if>
            <if test="rgt != null" >
                rgt,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=BIGINT},
            </if>
            <if test="orgName != null" >
                #{orgName,jdbcType=VARCHAR},
            </if>
            <if test="orgCode != null" >
                <![CDATA[
                pinyin(concat("'",#{orgName},"'")),
                ]]>
            </if>
            <if test="orgDesc != null" >
                #{orgDesc,jdbcType=VARCHAR},
            </if>
            <if test="fatherId != null" >
                #{fatherId,jdbcType=BIGINT},
            </if>
            <if test="lft != null" >
                #{lft,jdbcType=INTEGER},
            </if>
            <if test="rgt != null" >
                #{rgt,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>

    <update id="updateSysOrganizationOrgCodeById" parameterType="com.txp.app.system.dto.SysOrganization">
        update sys_organization set org_code=pinyin(CONCAT("'",#{orgName},"'")) where id=#{id}
    </update>

    <select id="selectDeleteOrg" parameterType="java.lang.String" resultType="java.lang.Integer">
        select delete_org(#{ids})
    </select>

    <select id="selectSysOrganizationById" parameterType="java.lang.String" resultType="java.util.Map">
        select * from sys_organization where id=#{id}
    </select>

    <update id="updateSysOrganization" parameterType="com.txp.app.system.dto.SysOrganization">
        update sys_organization
        <set >
            <if test="orgName != null" >
                org_name = #{orgName,jdbcType=VARCHAR},
            </if>
            <if test="orgCode != null" >
                org_code = #{orgCode,jdbcType=VARCHAR},
            </if>
            <if test="orgDesc != null" >
                org_desc = #{orgDesc,jdbcType=VARCHAR},
            </if>
            <if test="fatherId != null" >
                father_id = #{fatherId,jdbcType=BIGINT},
            </if>
            <if test="lft != null" >
                lft = #{lft,jdbcType=INTEGER},
            </if>
            <if test="rgt != null" >
                rgt = #{rgt,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <select id="findSysLogList" parameterType="map" resultType="com.txp.app.system.dto.SysLog">
        select id,operator,operate_time as operateTime, description, operate_result as operateResult,ip from sys_log where 1=1
        <if test="operator != null" >
            and operator LIKE CONCAT('%',#{operator},'%' )
        </if>
        <if test="startTime != null" >
            <![CDATA[
                and left(operate_time,10)>=#{startTime}
                ]]>
        </if>
        <if test="endTime != null" >
            <![CDATA[
                and left(operate_time,10)<=#{endTime}
                ]]>
        </if>
        ORDER BY operate_time DESC limit #{startIndex},#{endIndex}
    </select>

    <select id="findSysLogListCount" parameterType="map" resultType="java.lang.Long">
        select count(1) from sys_log where 1=1
        <if test="operator != null" >
            and operator LIKE CONCAT('%',#{operator},'%' )
        </if>
        <if test="startTime != null" >
            <![CDATA[
                and left(operate_time,10)>=#{startTime}
                ]]>
        </if>
        <if test="endTime != null" >
            <![CDATA[
                and left(operate_time,10)<=#{endTime}
                ]]>
        </if>
    </select>

    <select id="selectAllSysCity" resultType="com.txp.app.system.dto.SysCity">
      select id,city_name as cityName,city_desc as cityDesc from sys_city
    </select>

    <select id="selectSysCityByOrgId" parameterType="java.lang.String" resultType="com.txp.app.system.dto.SysCity">
      select c.id,c.city_name as cityName,c.city_desc as cityDesc from sys_orgCity o LEFT JOIN sys_city c on o.city_id=c.id where  o.org_id=#{orgId}
    </select>

    <select id="selectAllSysOrganization" resultType="com.txp.app.system.dto.SysOrganization">
      select o.id,
        o.org_name AS orgName,
        o.org_code AS orgCode,
        o.org_desc AS orgDesc,
        o.father_id AS fatherId,
        o.lft,
        o.rgt from sys_organization o
    </select>

    <insert id="insertSysMallLog" parameterType="com.txp.app.system.dto.SysMallLog" useGeneratedKeys="true" keyProperty="id">
        insert into sys_mall_log (operator,operate_time,model,description,operate_result,ip) values
        (#{operator},now(),#{model},#{description},#{operateResult},#{ip})
    </insert>

    <select id="findSysMallLogList" parameterType="map" resultType="com.txp.app.system.dto.SysMallLog">
        select id,operator,operate_time as operateTime, model, description, operate_result as operateResult,ip from sys_mall_log where 1=1
        <if test="operator != null" >
            and operator LIKE CONCAT('%',#{operator},'%' )
        </if>
        <if test="model != null" >
            and model = #{model}
        </if>
        <if test="startTime != null" >
            <![CDATA[
                and left(operate_time,10)>=#{startTime}
                ]]>
        </if>
        <if test="endTime != null" >
            <![CDATA[
                and left(operate_time,10)<=#{endTime}
                ]]>
        </if>
        ORDER BY operate_time DESC limit #{startIndex},#{endIndex}
    </select>

    <select id="findSysMallLogListCount" parameterType="map" resultType="java.lang.Long">
        select count(1) from sys_mall_log where 1=1
        <if test="operator != null" >
            and operator LIKE CONCAT('%',#{operator},'%' )
        </if>
        <if test="model != null" >
            and model = #{model}
        </if>
        <if test="startTime != null" >
            <![CDATA[
                and left(operate_time,10)>=#{startTime}
                ]]>
        </if>
        <if test="endTime != null" >
            <![CDATA[
                and left(operate_time,10)<=#{endTime}
                ]]>
        </if>
    </select>

</mapper>